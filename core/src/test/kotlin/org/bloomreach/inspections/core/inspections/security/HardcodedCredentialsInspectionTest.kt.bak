package org.bloomreach.inspections.core.inspections.security

import org.bloomreach.inspections.core.engine.*
import org.junit.jupiter.api.Test
import java.nio.file.Path
import kotlin.test.assertEquals
import kotlin.test.assertTrue

class HardcodedCredentialsInspectionTest {

    private val inspection = HardcodedCredentialsInspection()

    // Java Tests

    @Test
    fun `should detect hardcoded password in Java`() {
        val code = """
            package com.example;

            public class Config {
                private static final String DB_PASSWORD = "MySecretP@ssw0rd";
            }
        """.trimIndent()

        val issues = runJavaInspection(code)

        assertEquals(1, issues.size, "Should detect hardcoded password")
        assertTrue(issues[0].message.contains("Password"))
        assertEquals(Severity.ERROR, issues[0].severity)
    }

    @Test
    fun `should detect hardcoded API key in Java`() {
        val code = """
            package com.example;

            public class ApiClient {
                private String apiKey = "sk_live_1234567890abcdef";
            }
        """.trimIndent()

        val issues = runJavaInspection(code)

        assertEquals(1, issues.size, "Should detect hardcoded API key")
        assertTrue(issues[0].message.contains("API Key") || issues[0].message.contains("Credential"))
    }

    @Test
    fun `should not flag environment variable access`() {
        val code = """
            package com.example;

            public class Config {
                private String password = System.getenv("DB_PASSWORD");
            }
        """.trimIndent()

        val issues = runJavaInspection(code)

        assertEquals(0, issues.size, "Should not flag environment variable access")
    }

    @Test
    fun `should not flag placeholder values`() {
        val code = """
            package com.example;

            public class Config {
                private String password = "changeme";
                private String token = "TODO";
                private String apiKey = "\${API_KEY}";
            }
        """.trimIndent()

        val issues = runJavaInspection(code)

        assertEquals(0, issues.size, "Should not flag placeholder values")
    }

    @Test
    fun `should detect multiple hardcoded credentials`() {
        val code = """
            package com.example;

            public class Config {
                private String dbPassword = "Pass123!";
                private String apiKey = "key_abc123";
                private String authToken = "Bearer xyz789";
            }
        """.trimIndent()

        val issues = runJavaInspection(code)

        assertTrue(issues.size >= 2, "Should detect multiple hardcoded credentials")
    }

    // Properties File Tests

    @Test
    fun `should detect hardcoded password in properties file`() {
        val properties = """
            database.url=jdbc:mysql://localhost:3306/mydb
            database.password=MySecretPassword
            database.username=admin
        """.trimIndent()

        val issues = runPropertiesInspection(properties)

        assertEquals(1, issues.size, "Should detect hardcoded password in properties")
        assertTrue(issues[0].message.contains("Password"))
    }

    @Test
    fun `should not flag property placeholders`() {
        val properties = """
            database.password=\${DB_PASSWORD}
            api.key=\${API_KEY}
            auth.token=\${AUTH_TOKEN}
        """.trimIndent()

        val issues = runPropertiesInspection(properties)

        assertEquals(0, issues.size, "Should not flag property placeholders")
    }

    @Test
    fun `should ignore comments in properties`() {
        val properties = """
            # database.password=DontFlagThis
            database.password=\${DB_PASSWORD}
        """.trimIndent()

        val issues = runPropertiesInspection(properties)

        assertEquals(0, issues.size, "Should ignore commented lines")
    }

    // YAML Tests

    @Test
    fun `should detect hardcoded credentials in YAML`() {
        val yaml = """
            database:
              host: localhost
              port: 3306
              password: MySecretPassword
        """.trimIndent()

        val issues = runYamlInspection(yaml)

        assertEquals(1, issues.size, "Should detect hardcoded password in YAML")
        assertTrue(issues[0].message.contains("Password"))
    }

    @Test
    fun `should not flag YAML placeholders`() {
        val yaml = """
            database:
              password: \${DB_PASSWORD}
            api:
              key: \${API_KEY}
        """.trimIndent()

        val issues = runYamlInspection(yaml)

        assertEquals(0, issues.size, "Should not flag YAML placeholders")
    }

    @Test
    fun `should detect API keys in YAML`() {
        val yaml = """
            services:
              stripe:
                apiKey: sk_test_1234567890abcdef
              sendgrid:
                token: SG.1234567890abcdef
        """.trimIndent()

        val issues = runYamlInspection(yaml)

        assertTrue(issues.size >= 1, "Should detect API keys in YAML")
    }

    // XML Tests

    @Test
    fun `should detect hardcoded password in XML`() {
        val xml = """
            <?xml version="1.0"?>
            <configuration>
              <password>MySecretPassword</password>
            </configuration>
        """.trimIndent()

        val issues = runXmlInspection(xml)

        assertEquals(1, issues.size, "Should detect hardcoded password in XML")
    }

    @Test
    fun `should detect API key in XML`() {
        val xml = """
            <?xml version="1.0"?>
            <configuration>
              <apikey>abc123xyz789</apikey>
            </configuration>
        """.trimIndent()

        val issues = runXmlInspection(xml)

        assertEquals(1, issues.size, "Should detect API key in XML")
    }

    @Test
    fun `should not flag XML placeholders`() {
        val xml = """
            <?xml version="1.0"?>
            <configuration>
              <password>\${env.DB_PASSWORD}</password>
            </configuration>
        """.trimIndent()

        val issues = runXmlInspection(xml)

        assertEquals(0, issues.size, "Should not flag XML placeholders")
    }

    // Edge Cases

    @Test
    fun `should mask credential values in reports`() {
        val code = """
            package com.example;

            public class Config {
                private String password = "MyVeryLongPassword123!";
            }
        """.trimIndent()

        val issues = runJavaInspection(code)

        assertEquals(1, issues.size)
        val maskedValue = issues[0].metadata["maskedValue"] as? String
        assertTrue(maskedValue != null && maskedValue.contains("*"), "Should mask credential value")
        assertTrue(!issues[0].description.contains("MyVeryLongPassword123!"), "Should not expose full password")
    }

    @Test
    fun `should identify credential type correctly`() {
        val code = """
            package com.example;

            public class Config {
                private String password = "pass123";
                private String apiKey = "key123";
                private String token = "token123";
                private String secret = "secret123";
            }
        """.trimIndent()

        val issues = runJavaInspection(code)

        assertTrue(issues.size >= 4, "Should detect all credential types")

        val types = issues.map { it.metadata["credentialType"] as String }
        assertTrue(types.any { it.contains("Password") }, "Should identify password")
        assertTrue(types.any { it.contains("API Key") }, "Should identify API key")
        assertTrue(types.any { it.contains("Token") }, "Should identify token")
        assertTrue(types.any { it.contains("Secret") }, "Should identify secret")
    }

    @Test
    fun `should not flag common non-sensitive strings`() {
        val code = """
            package com.example;

            public class Config {
                private String password = "xxx";
                private String token = "****";
                private String apiKey = "example";
            }
        """.trimIndent()

        val issues = runJavaInspection(code)

        assertEquals(0, issues.size, "Should not flag common placeholder patterns")
    }

    @Test
    fun `should detect base64-like tokens`() {
        val code = """
            package com.example;

            public class Config {
                private String token = "VGhpc0lzQVZlcnlMb25nVG9rZW5UaGF0TG9va3NMaWtlQmFzZTY0RW5jb2RlZA==";
            }
        """.trimIndent()

        val issues = runJavaInspection(code)

        assertEquals(1, issues.size, "Should detect long base64-like tokens")
    }

    // Helper methods

    private fun runJavaInspection(code: String): List<InspectionIssue> {
        val file = createVirtualFile("Config.java", code, FileType.JAVA)
        val context = createContext(file, FileType.JAVA)
        return inspection.inspect(context)
    }

    private fun runPropertiesInspection(content: String): List<InspectionIssue> {
        val file = createVirtualFile("application.properties", content, FileType.PROPERTIES)
        val context = createContext(file, FileType.PROPERTIES)
        return inspection.inspect(context)
    }

    private fun runYamlInspection(content: String): List<InspectionIssue> {
        val file = createVirtualFile("application.yaml", content, FileType.YAML)
        val context = createContext(file, FileType.YAML)
        return inspection.inspect(context)
    }

    private fun runXmlInspection(content: String): List<InspectionIssue> {
        val file = createVirtualFile("config.xml", content, FileType.XML)
        val context = createContext(file, FileType.XML)
        return inspection.inspect(context)
    }

    private fun createVirtualFile(name: String, content: String, type: FileType): VirtualFile {
        return object : VirtualFile {
            override val path: Path = Path.of("/test/$name")
            override val name: String = name
            override val extension: String = when (type) {
                FileType.JAVA -> "java"
                FileType.PROPERTIES -> "properties"
                FileType.YAML -> "yaml"
                FileType.XML -> "xml"
                else -> ""
            }
            override fun readText(): String = content
            override fun exists(): Boolean = true
            override fun size(): Long = content.length.toLong()
            override fun lastModified(): Long = System.currentTimeMillis()
        }
    }

    private fun createContext(file: VirtualFile, language: FileType): InspectionContext {
        return InspectionContext(
            file = file,
            fileContent = file.readText(),
            language = language,
            projectRoot = Path.of("/test"),
            projectIndex = ProjectIndex(),
            config = InspectionConfig()
        )
    }
}
